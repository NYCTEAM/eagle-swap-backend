========================================
ä¿®å¤ç‰ˆæœ¬ - ä¸€é”®åˆ›å»º Swap Mining è¡¨
========================================

å¤åˆ¶ä¸‹é¢çš„å‘½ä»¤åˆ°æœåŠ¡å™¨æ‰§è¡Œï¼š

docker exec -it hocg04o8swccwggwc8kosc8g-133057446453 node -e "
const Database = require('better-sqlite3');
const path = require('path');
const fs = require('fs');

console.log('ğŸ”§ [Swap Mining] ä¿®å¤æ•°æ®åº“è¡¨\n');

const possibleDbPaths = [
  path.join(process.cwd(), 'data/eagleswap.db'),
  '/app/data/eagleswap.db',
  './data/eagleswap.db'
];

let dbPath = '';
for (const p of possibleDbPaths) {
  if (fs.existsSync(p)) {
    dbPath = p;
    break;
  }
}

if (!dbPath) {
  console.error('âŒ æ•°æ®åº“æ–‡ä»¶æœªæ‰¾åˆ°ï¼');
  process.exit(1);
}

console.log('âœ… ä½¿ç”¨æ•°æ®åº“:', dbPath);
const db = new Database(dbPath);

try {
  console.log('\nğŸ“Š æ£€æŸ¥ç°æœ‰è¡¨...');
  const tables = db.prepare('SELECT name FROM sqlite_master WHERE type=\"table\" ORDER BY name').all();
  console.log('æ‰¾åˆ°', tables.length, 'ä¸ªè¡¨');
  
  const swapMiningTables = ['user_claim_nonce', 'user_swap_stats', 'swap_transactions'];
  const existingTables = tables.map(t => t.name);
  
  swapMiningTables.forEach(tableName => {
    const exists = existingTables.includes(tableName);
    console.log('  -', tableName + ':', exists ? 'âœ… å­˜åœ¨' : 'âŒ ç¼ºå¤±');
  });
  
  console.log('\nğŸ”¨ åˆ›å»º user_claim_nonce è¡¨...');
  db.exec('CREATE TABLE IF NOT EXISTS user_claim_nonce (user_address TEXT PRIMARY KEY, nonce INTEGER NOT NULL DEFAULT 0, created_at DATETIME DEFAULT CURRENT_TIMESTAMP, updated_at DATETIME DEFAULT CURRENT_TIMESTAMP)');
  db.exec('CREATE INDEX IF NOT EXISTS idx_user_claim_nonce_address ON user_claim_nonce(user_address)');
  console.log('âœ… user_claim_nonce è¡¨å·²åˆ›å»º');
  
  console.log('\nğŸ”¨ åˆ›å»º user_swap_stats è¡¨...');
  db.exec('CREATE TABLE IF NOT EXISTS user_swap_stats (user_address TEXT PRIMARY KEY, total_trades INTEGER DEFAULT 0, total_volume_usdt REAL DEFAULT 0, total_fee_paid REAL DEFAULT 0, total_eagle_earned REAL DEFAULT 0, total_eagle_claimed REAL DEFAULT 0, created_at DATETIME DEFAULT CURRENT_TIMESTAMP, updated_at DATETIME DEFAULT CURRENT_TIMESTAMP)');
  db.exec('CREATE INDEX IF NOT EXISTS idx_user_swap_stats_address ON user_swap_stats(user_address)');
  db.exec('CREATE INDEX IF NOT EXISTS idx_user_swap_stats_volume ON user_swap_stats(total_volume_usdt)');
  console.log('âœ… user_swap_stats è¡¨å·²åˆ›å»º');
  
  console.log('\nğŸ”¨ åˆ›å»º swap_transactions è¡¨...');
  db.exec('CREATE TABLE IF NOT EXISTS swap_transactions (id INTEGER PRIMARY KEY AUTOINCREMENT, tx_hash TEXT UNIQUE NOT NULL, user_address TEXT NOT NULL, from_token TEXT NOT NULL, to_token TEXT NOT NULL, from_amount TEXT, to_amount TEXT, trade_value_usdt REAL DEFAULT 0, eagle_reward REAL DEFAULT 0, chain_id INTEGER NOT NULL, route_info TEXT, created_at DATETIME DEFAULT CURRENT_TIMESTAMP)');
  db.exec('CREATE INDEX IF NOT EXISTS idx_swap_tx_user ON swap_transactions(user_address)');
  db.exec('CREATE INDEX IF NOT EXISTS idx_swap_tx_hash ON swap_transactions(tx_hash)');
  db.exec('CREATE INDEX IF NOT EXISTS idx_swap_tx_chain ON swap_transactions(chain_id)');
  db.exec('CREATE INDEX IF NOT EXISTS idx_swap_tx_created ON swap_transactions(created_at)');
  console.log('âœ… swap_transactions è¡¨å·²åˆ›å»º');
  
  console.log('\nğŸ“‹ éªŒè¯è¡¨ç»“æ„:');
  swapMiningTables.forEach(tableName => {
    const exists = db.prepare('SELECT name FROM sqlite_master WHERE type=\"table\" AND name=?').get(tableName);
    if (exists) {
      const count = db.prepare('SELECT COUNT(*) as count FROM ' + tableName).get();
      console.log('  âœ…', tableName + ':', count.count, 'æ¡è®°å½•');
    }
  });
  
  console.log('\nğŸ§ª æµ‹è¯•æ•°æ®åº“æ“ä½œ...');
  const testAddress = '0x0000000000000000000000000000000000000001';
  db.prepare('INSERT OR IGNORE INTO user_claim_nonce (user_address, nonce) VALUES (?, 0)').run(testAddress);
  const testRecord = db.prepare('SELECT * FROM user_claim_nonce WHERE user_address = ?').get(testAddress);
  
  if (testRecord) {
    console.log('âœ… æ•°æ®åº“è¯»å†™æµ‹è¯•æˆåŠŸ');
    db.prepare('DELETE FROM user_claim_nonce WHERE user_address = ?').run(testAddress);
  }
  
  db.close();
  console.log('\nâœ… æ•°æ®åº“ä¿®å¤å®Œæˆï¼');
  console.log('ğŸš€ ç°åœ¨å¯ä»¥æµ‹è¯• Swap Mining æå–åŠŸèƒ½äº†');
  
} catch (error) {
  console.error('\nâŒ é”™è¯¯:', error.message);
  db.close();
  process.exit(1);
}
"
